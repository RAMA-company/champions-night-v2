<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل کاربری</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* استفاده از فونت Vazirmatn */
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f7fafc;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">
                <span id="gym-name">باشگاه</span> - پنل کاربری
            </h1>
            <div class="flex items-center space-x-4 space-x-reverse">
                <span id="user-email" class="text-gray-600"></span>
                <button id="logout-btn" class="bg-red-500 text-white py-2 px-4 rounded-full font-bold hover:bg-red-600 transition-colors duration-200">
                    خروج
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 flex-grow">
        <!-- Message Box -->
        <div id="message-box" class="hidden p-4 mb-4 text-sm rounded-lg border" role="alert">
            <span id="error-message-text" class="font-medium"></span>
            <button id="close-message-btn" type="button" class="float-left text-gray-400 hover:text-gray-600 focus:outline-none">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Card for User Info -->
            <div class="bg-white p-6 rounded-2xl shadow-lg text-center md:col-span-1 lg:col-span-1">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">
                    خوش آمدید، <span id="user-name">کاربر</span>!
                </h2>
                <p class="text-gray-600 text-sm" id="user-phone">شماره تماس: --</p>
                <p class="text-gray-600 text-sm" id="membership-code">کد عضویت: --</p>
            </div>

            <!-- Card for Subscription Status -->
            <div class="bg-white p-6 rounded-2xl shadow-lg md:col-span-1 lg:col-span-1">
                <h3 class="text-xl font-bold text-gray-800 mb-2">وضعیت اشتراک</h3>
                <div class="space-y-2">
                    <p>تاریخ شروع: <span id="start-date" class="font-bold">--</span></p>
                    <p>تاریخ پایان: <span id="end-date" class="font-bold">--</span></p>
                    <p>وضعیت: <span id="sub-status" class="font-bold text-gray-500">--</span></p>
                </div>
            </div>

            <!-- Card for Attendance History -->
            <div class="bg-white p-6 rounded-2xl shadow-lg md:col-span-2 lg:col-span-1">
                <h3 class="text-xl font-bold text-gray-800 mb-2">تاریخچه حضور</h3>
                <div class="overflow-x-auto">
                    <ul id="activity-list" class="space-y-2 text-sm">
                        <!-- Attendance list will be generated by JS -->
                        <li class="text-gray-500">اطلاعاتی یافت نشد.</li>
                    </ul>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="p-4 text-center text-gray-500 text-sm">
        <p>&copy; 2023 پلتفرم مدیریت باشگاه. تمامی حقوق محفوظ است.</p>
    </footer>

    <!-- Scripts -->
    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase Configuration -->
    <script>
        // این فایل شامل تنظیمات پروژه Supabase است.
        const SUPABASE_URL = 'https://mchjfnbbfmslocmexwxs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jaGpmbmJiZm1zbG9jbWV4d3hzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3ODk4ODcsImV4cCI6MjA3MTM2NTg4N30.IzJfkGRfyS7fLdTXu0yckGwKRFVt_wMFLZY8g68qBnM';
    </script>

    <!-- Main Application Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const supabaseUrl = typeof SUPABASE_URL !== 'undefined' ? SUPABASE_URL : null;
            const supabaseKey = typeof SUPABASE_ANON_KEY !== 'undefined' ? SUPABASE_ANON_KEY : null;

            if (!supabaseUrl || !supabaseKey) {
                console.error('Supabase URL or Key is not defined.');
                return;
            }

            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            // بررسی وضعیت احراز هویت
            const { data: { user }, error } = await supabase.auth.getUser();

            if (error || !user) {
                // اگر کاربر وارد نشده باشد، به صفحه ورود برگردانده می‌شود
                window.location.href = 'index.html'; 
                return;
            }

            // عناصر DOM
            const userNameSpan = document.getElementById('user-name');
            const userEmailSpan = document.getElementById('user-email');
            const userPhoneSpan = document.getElementById('user-phone');
            const membershipCodeSpan = document.getElementById('membership-code');
            const startDateSpan = document.getElementById('start-date');
            const endDateSpan = document.getElementById('end-date');
            const subStatusSpan = document.getElementById('sub-status');
            const activityList = document.getElementById('activity-list');
            const messageBox = document.getElementById('message-box');
            const errorMessageText = document.getElementById('error-message-text');
            const closeMessageBtn = document.getElementById('close-message-btn');

            // تابع کمکی برای نمایش پیام‌ها
            function showMessage(message, type = 'error') {
                errorMessageText.textContent = message;
                messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'border-red-400', 'border-green-400', 'text-red-700', 'text-green-700');
                if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                } else {
                    messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                }
                messageBox.classList.remove('hidden');
            }

            // شنونده رویداد دکمه بستن پیام
            if (closeMessageBtn) {
                closeMessageBtn.addEventListener('click', () => {
                    messageBox.classList.add('hidden');
                });
            }

            // دریافت و نمایش اطلاعات کاربر از جدول users
            async function fetchUserData(userId) {
                try {
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('full_name, phone, membership_code')
                        .eq('id', userId)
                        .single();

                    if (userError) throw userError;
                    
                    if (userData) {
                        userNameSpan.textContent = userData.full_name;
                        userPhoneSpan.textContent = `شماره تماس: ${userData.phone || '--'}`;
                        membershipCodeSpan.textContent = `کد عضویت: ${userData.membership_code || '--'}`;
                    }
                } catch (err) {
                    console.error('Error fetching user data:', err.message);
                    showMessage('خطا در بارگیری اطلاعات کاربر.', 'error');
                }
            }

            // دریافت و نمایش وضعیت اشتراک
            async function fetchSubscriptionData(userId) {
                try {
                    const { data: subData, error: subError } = await supabase
                        .from('subscriptions')
                        .select('start_date, end_date, status')
                        .eq('user_id', userId)
                        .order('created_at', { ascending: false })
                        .limit(1)
                        .single();

                    if (subError && subError.code !== 'PGRST116') { // Ignore "no rows found" error
                        throw subError;
                    }
                    
                    if (subData) {
                        startDateSpan.textContent = subData.start_date || '--';
                        endDateSpan.textContent = subData.end_date || '--';
                        subStatusSpan.textContent = subData.status || '--';

                        if (subData.status === 'active') {
                            subStatusSpan.classList.add('text-green-600');
                            subStatusSpan.classList.remove('text-red-600', 'text-gray-500');
                        } else if (subData.status === 'expired') {
                            subStatusSpan.classList.add('text-red-600');
                            subStatusSpan.classList.remove('text-green-600', 'text-gray-500');
                        }
                    } else {
                        startDateSpan.textContent = '--';
                        endDateSpan.textContent = '--';
                        subStatusSpan.textContent = 'اشتراک یافت نشد';
                    }
                } catch (err) {
                    console.error('Error fetching subscription data:', err.message);
                    showMessage('خطا در بارگیری وضعیت اشتراک.', 'error');
                }
            }

            // دریافت و نمایش تاریخچه حضور
            async function fetchActivityLog(userId) {
                try {
                    const { data: logData, error: logError } = await supabase
                        .from('activity_log')
                        .select('timestamp')
                        .eq('user_id', userId)
                        .order('timestamp', { ascending: false })
                        .limit(10);

                    if (logError) throw logError;

                    if (logData && logData.length > 0) {
                        activityList.innerHTML = ''; // Clear the "No data" message
                        logData.forEach(log => {
                            const li = document.createElement('li');
                            const date = new Date(log.timestamp).toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                            const time = new Date(log.timestamp).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
                            li.textContent = `${date} ساعت ${time}`;
                            li.classList.add('bg-gray-50', 'p-2', 'rounded-md');
                            activityList.appendChild(li);
                        });
                    }
                } catch (err) {
                    console.error('Error fetching activity log:', err.message);
                    showMessage('خطا در بارگیری تاریخچه حضور.', 'error');
                }
            }

            // فراخوانی توابع در زمان بارگذاری صفحه
            userEmailSpan.textContent = user.email;
            await fetchUserData(user.id);
            await fetchSubscriptionData(user.id);
            await fetchActivityLog(user.id);

            // منطق خروج از حساب کاربری
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    const { error } = await supabase.auth.signOut();
                    if (error) {
                        console.error('Error signing out:', error.message);
                    }
                    window.location.href = 'index.html';
                });
            }
        });
    </script>
</body>
</html>
